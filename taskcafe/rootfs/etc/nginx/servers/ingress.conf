#
# Wireguard UI has multiple session cookies.
#
# Home Assistant ingress endpoints support only a single Set-Cookie header.
#   https://github.com/home-assistant/supervisor/issues/4290
#
# Backend to frontend
#   The following map and cookie configs read cookies from backend and combine
#   them into a single Set-Cooke before sending to client through frontend.
#
# Frontend to backend
#   When client sends back the combined cookie the cookies are then split up
#   again before being sent to backend.
################################################################################

server {
    listen %%interface%%:8099 default_server;

    include /etc/nginx/includes/server_params.conf;
    include /etc/nginx/includes/proxy_params.conf;

    location / {
        #allow all;
        allow   172.30.32.2;
        deny    all;

        proxy_set_header X-Remote-User-Name $http_x_remote_user_name;

        # https://github.com/EmbarkStudios/wg-ui/issues/94
        sub_filter_types *;
        sub_filter_once off;
        sub_filter 'O.p="/"'  "O.p=\"$http_x_ingress_path/\"";
        sub_filter 'href:"/'  "href:\"$http_x_ingress_path/";
        sub_filter 'src="/'  "src=\"$http_x_ingress_path/";
        #sub_filter '/api' "$http_x_ingress_path/api";
        sub_filter 'path:"' "path:\"$http_x_ingress_path/";
        sub_filter '"/new-client"' "\"$http_x_ingress_path/new-client\"";
        sub_filter '"/client/"' "\"$http_x_ingress_path/client/\"";
        sub_filter '"/",{replace' "\"$http_x_ingress_path/\",{replace";
        sub_filter 'href="/'  "href=\"$http_x_ingress_path/";

        # added since converting this addon to https://github.com/ngoduykhanh/wireguard-ui
        sub_filter 'url: \'/' "url: '$http_x_ingress_path/";
        sub_filter "href = '/" "href = '$http_x_ingress_path/";
        sub_filter "href='/" "href='$http_x_ingress_path/";
        sub_filter "href = \"/" "href = \"$http_x_ingress_path/";
        sub_filter "href=\"/" "href=\"$http_x_ingress_path/";
        sub_filter '/static/' "$http_x_ingress_path/static/";
        sub_filter '/auth/' "$http_x_ingress_path/auth/";
        sub_filter '/login' "$http_x_ingress_path/login";
        sub_filter '/register' "$http_x_ingress_path/register";
        sub_filter "to: \"/" "to: \"$http_x_ingress_path/";
        sub_filter "to:\"/" "to:\"$http_x_ingress_path/";
        sub_filter "to: '/" "to: '$http_x_ingress_path/";
        sub_filter "to:'/" "to:'$http_x_ingress_path/";

        # login pages and redirects
        proxy_redirect ~^(\/[^?]+)(\?next=)\/(.*)$ "$http_x_ingress_path$1$2$http_x_ingress_path/$3";
        proxy_redirect / "$http_x_ingress_path/";
        absolute_redirect off;

        proxy_pass http://backend/;
    }
}
